<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoPoly: 永續大富翁</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel (JSX Support) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-white': 'rgba(255, 255, 255, 0.7)',
                        'brand-green': '#10b981',
                        'brand-blue': '#3b82f6',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'blob': 'blob 7s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'dice-shake': 'dice-shake 0.5s linear infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        'dice-shake': {
                            '0%': { transform: 'translate(1px, 1px) rotate(0deg)' },
                            '10%': { transform: 'translate(-1px, -2px) rotate(-5deg)' },
                            '20%': { transform: 'translate(-3px, 0px) rotate(5deg)' },
                            '30%': { transform: 'translate(3px, 2px) rotate(0deg)' },
                            '40%': { transform: 'translate(1px, -1px) rotate(5deg)' },
                            '50%': { transform: 'translate(-1px, 2px) rotate(-5deg)' },
                            '60%': { transform: 'translate(-3px, 1px) rotate(0deg)' },
                            '70%': { transform: 'translate(3px, 1px) rotate(-5deg)' },
                            '80%': { transform: 'translate(-1px, -1px) rotate(5deg)' },
                            '90%': { transform: 'translate(1px, 2px) rotate(0deg)' },
                            '100%': { transform: 'translate(1px, -2px) rotate(-5deg)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #e0f2fe;
            overflow: hidden; 
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        #app-background {
            background-image: url('bg-main.png');
            background-size: cover;
            background-position: center;
            opacity: 0.5;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalPop {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .pattern-dots {
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 20px 20px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        .tile-hover:hover {
            transform: translateY(-2px) scale(1.02);
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <div id="app-background" class="fixed inset-0 z-[-1] pointer-events-none transition-opacity duration-1000"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef } = React;

        const TileType = { PROPERTY: 'PROPERTY', START: 'START', CHANCE: 'CHANCE', JAIL: 'JAIL', TAX: 'TAX', PARKING: 'PARKING', GO_TO_JAIL: 'GO_TO_JAIL' };

        // 20 Tiles Layout (Translated)
        const INITIAL_TILES = [
            // Bottom Row
            { id: 0, name: '起點', type: TileType.START, description: '領取 $200' },
            { id: 1, name: '太陽能農場', type: TileType.PROPERTY, price: 60, rent: 10, group: 'brown', level: 0 },
            { id: 2, name: '風力發電機', type: TileType.PROPERTY, price: 60, rent: 15, group: 'brown', level: 0 },
            { id: 3, name: '機會', type: TileType.CHANCE },
            { id: 4, name: '生態稅', type: TileType.TAX, price: 100, description: '支付 $100' },
            { id: 5, name: '監獄', type: TileType.JAIL, description: '純粹參觀' },

            // Left Column
            { id: 6, name: '水力大壩', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue', level: 0 }, 
            { id: 7, name: '回收中心', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue', level: 0 },
            { id: 8, name: '生技實驗室', type: TileType.PROPERTY, price: 120, rent: 25, group: 'light_blue', level: 0 },
            { id: 9, name: '機會', type: TileType.CHANCE },
            { id: 10, name: '免費停車', type: TileType.PARKING, description: '休息一下' },

            // Top Row
            { id: 11, name: '社區花園', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink', level: 0 },
            { id: 12, name: '充電站', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink', level: 0 }, 
            { id: 13, name: '綠色大學', type: TileType.PROPERTY, price: 160, rent: 35, group: 'pink', level: 0 },
            { id: 14, name: '碳稅', type: TileType.TAX, price: 50, description: '支付 $50' },
            { id: 15, name: '入獄', type: TileType.GO_TO_JAIL, description: '前往監獄' },

            // Right Column
            { id: 16, name: '環保塔', type: TileType.PROPERTY, price: 180, rent: 40, group: 'green', level: 0 },
            { id: 17, name: '垂直森林', type: TileType.PROPERTY, price: 180, rent: 40, group: 'green', level: 0 },
            { id: 18, name: '智慧城市', type: TileType.PROPERTY, price: 200, rent: 50, group: 'green', level: 0 },
            { id: 19, name: '機會', type: TileType.CHANCE },
        ];

        const SDG_QUESTIONS = [
            // Basics & General
            { q: "聯合國永續發展目標 (SDGs) 共有幾項？", a: ["10 項", "15 項", "17 項"], c: 2 },
            { q: "2030 議程的目標達成年份是？", a: ["2025 年", "2030 年", "2050 年"], c: 1 },
            { q: "SDGs 的核心原則是什麼？", a: ["不遺漏任何人", "利潤優先", "科技至上"], c: 0 },

            // Environment
            { q: "SDG 13 是關於什麼？", a: ["氣候行動", "消除飢餓", "優質教育"], c: 0 },
            { q: "哪種氣體對全球暖化影響最大？", a: ["氧氣", "二氧化碳", "氮氣"], c: 1 },
            { q: "SDG 7 提倡哪種能源？", a: ["煤炭", "太陽能 (再生能源)", "天然氣"], c: 1 },
            { q: "SDG 12 提到的廢棄物 '3R' 原則是什麼？", a: ["閱讀、跑步、休息", "減量、重複使用、回收", "米飯、雨水、河流"], c: 1 },
            { q: "哪個領域消耗最多的淡水資源 (SDG 6)？", a: ["家庭用水", "農業", "工業"], c: 1 },
            { q: "SDG 14 '保育海洋生態' 主要保護什麼？", a: ["海洋與海洋生物", "地下水", "雨水"], c: 0 },
            { q: "SDG 15 '保育陸域生態' 旨在對抗？", a: ["都市化", "沙漠化與生物多樣性喪失", "雲層形成"], c: 1 },

            // Social
            { q: "SDG 1 旨在消除各地的什麼？", a: ["貧窮", "網路延遲", "交通阻塞"], c: 0 },
            { q: "哪項目標專注於 '消除飢餓'？", a: ["目標 1", "目標 2", "目標 5"], c: 1 },
            { q: "SDG 3 確保健康生活並促進...？", a: ["財富", "福祉", "名聲"], c: 1 },
            { q: "SDG 4 旨在確保包容和公平的...？", a: ["教育", "娛樂", "交通"], c: 0 },
            { q: "SDG 5 旨在實現哪方面的平等？", a: ["性別", "大企業", "遊戲玩家"], c: 0 },

            // Economy & Community
            { q: "SDG 8 促進體面工作和...？", a: ["經濟成長", "睡覺", "免費午餐"], c: 0 },
            { q: "SDG 11 旨在讓城市變得...？", a: ["擁擠", "包容、安全、韌性及永續", "昂貴"], c: 1 },
            { q: "哪項目標致力於減少不平等 (SDG 10)？", a: ["國家內部和國家之間", "僅限富裕國家", "行星之間"], c: 0 },
            { q: "SDG 9 專注於工業、創新和...？", a: ["昆蟲", "基礎建設", "冰山"], c: 1 },
            { q: "SDG 17 強調什麼的重要性？", a: ["競爭", "夥伴關係", "孤立"], c: 1 },
        ];

        const PROPERTY_COLORS = {
            brown: '#8d6e63',
            light_blue: '#4fc3f7',
            pink: '#f06292',
            green: '#66bb6a',
        };

        const AVATARS = [
            { id: 'p1', color: 'bg-red-500', border: 'border-red-500', name: '紅隊' },
            { id: 'p2', color: 'bg-blue-500', border: 'border-blue-500', name: '藍隊' },
            { id: 'p3', color: 'bg-yellow-500', border: 'border-yellow-500', name: '黃隊' },
            { id: 'p4', color: 'bg-purple-500', border: 'border-purple-500', name: '紫隊' },
        ];

        function getTileCoordinates(id) {
            const rowSize = 100 / 6;
            const colSize = 100 / 6;
            if (id >= 0 && id <= 5) return { top: 5 * rowSize, left: (5 - id) * colSize };
            if (id >= 6 && id <= 10) return { top: (11 - id) * rowSize, left: 0 };
            if (id >= 11 && id <= 15) return { top: 0, left: (id - 10) * colSize };
            if (id >= 16 && id <= 19) return { top: (id - 14) * rowSize, left: 5 * colSize };
            return { top: 0, left: 0 };
        }

        const initialState = {
            screen: 'SETUP',
            players: [],
            currentPlayerIdx: 0,
            board: INITIAL_TILES,
            dice: [1, 1],
            isDiceRolling: false,
            stepsRemaining: 0,
            activeModal: null,
            log: [],
            winner: null
        };

        function reducer(state, action) {
            switch (action.type) {
                case 'START_GAME':
                    return { ...state, screen: 'GAME', players: action.payload, log: ['遊戲開始！'] };
                
                case 'ROLL_DICE_START':
                    return { ...state, isDiceRolling: true };

                case 'ROLL_DICE_COMPLETE': {
                    const { die1, die2 } = action.payload;
                    const roll = die1 + die2;
                    const player = state.players[state.currentPlayerIdx];
                    let newLog = [...state.log, `${player.name} 擲出了 ${roll} (${die1}+${die2})。`];

                    if (player.isInJail) {
                        const isDouble = die1 === die2;
                        if (isDouble) {
                             newLog.push("雙骰！成功越獄！");
                             const newPlayers = [...state.players];
                             newPlayers[state.currentPlayerIdx] = { ...player, isInJail: false };
                             return { ...state, dice: [die1, die2], isDiceRolling: false, players: newPlayers, log: newLog, stepsRemaining: roll };
                        } else {
                            newLog.push("沒有雙骰，繼續服刑。");
                             return { ...state, dice: [die1, die2], isDiceRolling: false, log: newLog, stepsRemaining: 0, activeModal: { type: 'NOTIFY', data: { title: '監獄', message: '你沒有擲出雙骰，回合結束。' } } };
                        }
                    }
                    return { ...state, dice: [die1, die2], isDiceRolling: false, log: newLog, stepsRemaining: roll };
                }

                case 'MOVE_STEP': {
                    if (state.stepsRemaining <= 0) return state;
                    const player = state.players[state.currentPlayerIdx];
                    if (!player) return state;

                    const newPos = (player.position + 1) % 20;
                    let money = player.money;
                    let passedGoMsg = null;
                    if (newPos === 0) {
                        money += 200;
                        passedGoMsg = `${player.name} 經過起點 (+$200)。`;
                    }

                    const updatedPlayers = [...state.players];
                    updatedPlayers[state.currentPlayerIdx] = { ...player, position: newPos, money: money };
                    let newLog = state.log;
                    if (passedGoMsg) newLog = [...state.log, passedGoMsg];

                    return { ...state, players: updatedPlayers, stepsRemaining: state.stepsRemaining - 1, log: newLog };
                }

                case 'LAND_ON_TILE': {
                    const player = state.players[state.currentPlayerIdx];
                    if (!player) return state;
                    const tile = state.board[player.position];
                    
                    if (tile.type === TileType.GO_TO_JAIL) {
                        const jailedPlayers = [...state.players];
                        jailedPlayers[state.currentPlayerIdx] = { ...player, position: 5, isInJail: true };
                        return { ...state, players: jailedPlayers, log: [...state.log, `${player.name} 入獄了！`], activeModal: { type: 'NOTIFY', data: { title: '入獄', message: '你被送進監獄了！' } } };
                    }

                    if (tile.type === TileType.PROPERTY) {
                        if (!tile.owner) {
                            if (player.money >= tile.price) {
                                return { ...state, activeModal: { type: 'QUIZ', data: { tile } } };
                            }
                        } else if (tile.owner !== player.id && !player.isInJail) {
                            const ownerId = tile.owner;
                            const groupTiles = state.board.filter(t => t.group === tile.group);
                            const hasMonopoly = groupTiles.every(t => t.owner === ownerId);
                            const rawRent = tile.rent * (tile.level + 1);
                            const finalRent = hasMonopoly ? rawRent * 2 : rawRent;

                            return { ...state, activeModal: { type: 'RENT', data: { tile, amount: finalRent, isMonopoly: hasMonopoly } } };
                        }
                    } else if (tile.type === TileType.TAX) {
                        const taxedPlayers = [...state.players];
                        taxedPlayers[state.currentPlayerIdx].money -= tile.price;
                        return { ...state, players: taxedPlayers, log: [...state.log, `${player.name} 支付了 $${tile.price} 稅金。`], activeModal: { type: 'NOTIFY', data: { title: '稅金', message: `你支付了 $${tile.price} 的稅金。` } } };
                    } else if (tile.type === TileType.CHANCE) {
                         const gain = Math.random() > 0.5;
                         const amount = 50;
                         const chancePlayers = [...state.players];
                         if (gain) chancePlayers[state.currentPlayerIdx].money += amount;
                         else chancePlayers[state.currentPlayerIdx].money -= amount;
                         const msg = gain ? `銀行作業疏失！ +$${amount}` : `超速罰單！ -$${amount}`;
                         return { ...state, players: chancePlayers, activeModal: { type: 'NOTIFY', data: { title: '機會', message: msg } } };
                    }
                    if ([TileType.START, TileType.JAIL, TileType.PARKING].includes(tile.type)) {
                         return { ...state, activeModal: null }; 
                    }
                    return state;
                }

                case 'PAY_BAIL': {
                    const player = state.players[state.currentPlayerIdx];
                    if (player.money < 50) return state;
                    const newPlayers = [...state.players];
                    newPlayers[state.currentPlayerIdx] = { ...player, money: player.money - 50, isInJail: false };
                    return { ...state, players: newPlayers, log: [...state.log, `${player.name} 支付了 $50 保釋金。`] };
                }

                case 'BUY_PROPERTY': {
                    const { tile } = action.payload;
                    const player = state.players[state.currentPlayerIdx];
                    const newPlayers = [...state.players];
                    newPlayers[state.currentPlayerIdx].money -= tile.price;
                    const newBoard = [...state.board];
                    newBoard[tile.id] = { ...tile, owner: player.id, ownerColor: player.color };
                    return { ...state, players: newPlayers, board: newBoard, activeModal: { type: 'NOTIFY', data: { title: '購買成功！', message: `你買下了 ${tile.name}！` } }, log: [...state.log, `${player.name} 購買了 ${tile.name}。`] };
                }

                case 'PAY_RENT': {
                    const { amount, tile } = action.payload;
                    const currentPlayer = state.players[state.currentPlayerIdx];
                    const ownerIdx = state.players.findIndex(p => p.id === tile.owner);
                    const newPlayers = [...state.players];
                    newPlayers[state.currentPlayerIdx].money -= amount;
                    newPlayers[ownerIdx].money += amount;
                    return { ...state, players: newPlayers, activeModal: null, log: [...state.log, `${currentPlayer.name} 支付 $${amount} 租金給 ${newPlayers[ownerIdx].name}。`] };
                }

                case 'UPGRADE_TILE': {
                    const { tile } = action.payload;
                    const player = state.players.find(p => p.id === tile.owner);
                    const cost = Math.floor(tile.price * 0.5);
                    if (player.money < cost || tile.level >= 4) return state;
                    const pIdx = state.players.findIndex(p => p.id === player.id);
                    const newPlayers = [...state.players];
                    newPlayers[pIdx].money -= cost;
                    const newBoard = [...state.board];
                    newBoard[tile.id] = { ...tile, level: tile.level + 1 };
                    return { ...state, players: newPlayers, board: newBoard, activeModal: { type: 'NOTIFY', data: { title: '升級成功！', message: `你在 ${tile.name} 上蓋了一棟房子。` } }, log: [...state.log, `${player.name} 升級了 ${tile.name}。`] }
                }

                case 'NEXT_TURN': {
                    const nextIdx = (state.currentPlayerIdx + 1) % state.players.length;
                    return { ...state, currentPlayerIdx: nextIdx, activeModal: null, dice: [1, 1], stepsRemaining: 0 };
                }
                
                case 'CLOSE_MODAL':
                    return { ...state, activeModal: null };

                case 'OPEN_INSPECT':
                    return { ...state, activeModal: { type: 'INSPECT', data: { tile: action.payload } } };

                default: return state;
            }
        }

        function SetupScreen({ onStart }) {
            const [count, setCount] = useState(2);
            const [names, setNames] = useState(['玩家 1', '玩家 2']);

            const updateCount = (n) => {
                setCount(n);
                setNames(Array(n).fill('').map((_, i) => `玩家 ${i + 1}`));
            };

            const updateName = (i, val) => {
                const newNames = [...names];
                newNames[i] = val;
                setNames(newNames);
            };

            const handleStart = () => {
                const players = names.map((name, i) => ({
                    id: AVATARS[i].id,
                    name,
                    color: AVATARS[i].color,
                    money: 1000,
                    position: 0,
                    isInJail: false
                }));
                onStart(players);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="glass-panel p-8 rounded-3xl max-w-md w-full text-center">
                        <h1 className="text-4xl font-extrabold text-emerald-600 mb-2">EcoPoly</h1>
                        <p className="text-slate-500 mb-8">永續大富翁 • 繁體中文版</p>
                        
                        <div className="mb-6">
                            <label className="block text-left text-sm font-bold text-slate-600 mb-2">玩家人數</label>
                            <div className="flex gap-2 justify-center">
                                {[2, 3, 4].map(n => (
                                    <button key={n} onClick={() => updateCount(n)}
                                        className={`w-12 h-12 rounded-xl font-bold transition-all ${count === n ? 'bg-emerald-500 text-white shadow-lg scale-110' : 'bg-slate-200 text-slate-500 hover:bg-slate-300'}`}>
                                        {n}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-3 mb-8">
                            {names.map((name, i) => (
                                <div key={i} className="flex items-center gap-3">
                                    <div className={`w-8 h-8 rounded-full ${AVATARS[i].color} flex items-center justify-center text-white text-xs font-bold shadow`}>
                                        {AVATARS[i].id.toUpperCase().replace('P', 'P')}
                                    </div>
                                    <input 
                                        type="text" 
                                        value={name}
                                        onChange={(e) => updateName(i, e.target.value)}
                                        className="flex-1 bg-white/50 border border-slate-300 rounded-lg px-3 py-2 text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                                    />
                                </div>
                            ))}
                        </div>

                        <button onClick={handleStart} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-600/30 transition-all active:scale-95">
                            開始遊戲
                        </button>

                         <div className="mt-6 flex justify-center gap-4 text-sm text-slate-400">
                             <a href="index.html" className="hover:text-emerald-600 hover:underline">回主選單</a>
                             <span>|</span>
                             <a href="ecopoly.html" className="hover:text-emerald-600 hover:underline">English</a>
                         </div>
                    </div>
                </div>
            );
        }

        const HouseIcon = () => (
            <svg viewBox="0 0 24 24" fill="currentColor" className="w-3 h-3 text-white drop-shadow-md">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
        );

        function Tile({ data, players, onClick }) {
            const isCorner = [0, 5, 10, 15].includes(data.id);
            let gridArea = {};
            if (data.id >= 0 && data.id <= 5) gridArea = { gridColumnStart: 6 - data.id, gridRowStart: 6 };
            else if (data.id >= 6 && data.id <= 10) gridArea = { gridColumnStart: 1, gridRowStart: 11 - data.id };
            else if (data.id >= 11 && data.id <= 15) gridArea = { gridColumnStart: data.id - 10, gridRowStart: 1 };
            else gridArea = { gridColumnStart: 6, gridRowStart: data.id - 14 };

            const groupColor = data.group ? PROPERTY_COLORS[data.group] : null;
            let flexDir = 'flex-col';
            let barClass = 'h-1/5 w-full';
            if (data.id >= 0 && data.id <= 5) flexDir = 'flex-col-reverse'; 
            else if (data.id >= 6 && data.id <= 10) { flexDir = 'flex-row'; barClass = 'w-1/5 h-full'; } 
            else if (data.id >= 11 && data.id <= 15) flexDir = 'flex-col'; 
            else { flexDir = 'flex-row-reverse'; barClass = 'w-1/5 h-full'; }
            if (isCorner) flexDir = 'flex-col justify-center items-center';

            const ownedBy = players.find(p => p.id === data.owner);
            const borderStyle = ownedBy ? `ring-4 ring-inset ${ownedBy.color.replace('bg-', 'ring-')} z-10` : 'border border-slate-300';

            return (
                <div onClick={() => onClick(data)} style={gridArea} className={`relative bg-white/90 backdrop-blur-sm shadow-sm flex ${flexDir} overflow-hidden transition-all tile-hover cursor-pointer ${borderStyle} ${isCorner ? 'bg-slate-100' : ''}`}>
                    {!isCorner && groupColor && (
                        <div style={{ backgroundColor: groupColor }} className={`${barClass} relative`}>
                            {data.level > 0 && (
                                <div className="absolute inset-0 flex items-center justify-center gap-0.5">
                                    {Array(data.level).fill(0).map((_, i) => <HouseIcon key={i} />)}
                                </div>
                            )}
                        </div>
                    )}
                    <div className="flex-1 flex flex-col items-center justify-center p-1 text-center w-full">
                        <div className="flex items-center justify-center gap-1 w-full">
                            {ownedBy && (
                                <div className={`w-4 h-4 rounded-full ${ownedBy.color} text-[8px] text-white flex items-center justify-center font-bold shadow-sm shrink-0`}>
                                    {ownedBy.name.charAt(0)}
                                </div>
                            )}
                            <span className="text-[1.2vmin] font-bold leading-tight truncate w-full">{data.name}</span>
                        </div>
                        {!isCorner && data.price && <span className="text-[1vmin] text-slate-500">${data.price}</span>}
                        {isCorner && <span className="text-[1vmin] text-slate-400 mt-1">{data.description}</span>}
                    </div>
                </div>
            );
        }

        function Modal({ children, headerClass = 'bg-slate-100', onClose }) {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden modal-enter" onClick={e => e.stopPropagation()}>
                        <div className={`p-4 ${headerClass}`}></div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        }

        function ModalManager({ activeModal, dispatch, players }) {
            if (!activeModal) return null;
            const { type, data } = activeModal;
            const handleClose = () => {
                if (['NOTIFY', 'INSPECT'].includes(type)) {
                    dispatch({ type: 'CLOSE_MODAL' });
                    if (type === 'NOTIFY' && !data.noTurnEnd) dispatch({ type: 'NEXT_TURN' }); 
                }
            };

            if (type === 'NOTIFY') {
                return (
                    <Modal onClose={handleClose}>
                        <h3 className="text-xl font-bold text-center mb-2">{data.title}</h3>
                        <p className="text-center text-slate-600 mb-6">{data.message}</p>
                        <button onClick={handleClose} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">確認</button>
                    </Modal>
                );
            }

            if (type === 'QUIZ') {
                const question = SDG_QUESTIONS[Math.floor(Math.random() * SDG_QUESTIONS.length)];
                const answer = (idx) => {
                    if (idx === question.c) dispatch({ type: 'BUY_PROPERTY', payload: { tile: data.tile } });
                    else {
                        dispatch({ type: 'NOTIFY', payload: { title: '答錯了', message: '你錯失了購買這塊地產的機會。' } });
                        dispatch({ type: 'CLOSE_MODAL' });
                        dispatch({ type: 'NEXT_TURN' });
                    }
                };
                return (
                    <Modal headerClass="bg-brand-green">
                        <h3 className="text-center font-bold text-emerald-700 mb-1">永續問答</h3>
                        <p className="text-center text-sm text-emerald-600 mb-4">回答問題以購買 {data.tile.name}</p>
                        <p className="font-bold text-lg mb-6 text-center">{question.q}</p>
                        <div className="space-y-2">
                            {question.a.map((ans, i) => (
                                <button key={i} onClick={() => answer(i)} className="w-full p-3 text-left border rounded-lg hover:bg-emerald-5 transition-colors">{ans}</button>
                            ))}
                        </div>
                    </Modal>
                );
            }

            if (type === 'RENT') {
                const owner = players.find(p => p.id === data.tile.owner);
                return (
                    <Modal headerClass={data.tile.group ? `bg-[${PROPERTY_COLORS[data.tile.group]}]` : 'bg-red-100'}>
                         <h3 className="text-xl font-bold text-center mb-2">支付租金</h3>
                         <p className="text-center text-slate-600 mb-2">你來到了 {data.tile.name}</p>
                         <div className="flex justify-center items-center gap-2 mb-6">
                            <span className="text-2xl font-bold text-slate-800">${data.amount}</span>
                            <span className="text-slate-400">➔</span>
                            <div className={`w-6 h-6 rounded-full ${owner.color}`}></div>
                         </div>
                         {data.isMonopoly && (
                             <div className="text-center mb-4">
                                <span className="bg-orange-100 text-orange-600 px-2 py-1 rounded text-xs font-bold border border-orange-200">壟斷加成 x2</span>
                             </div>
                         )}
                         <button onClick={() => {
                             dispatch({ type: 'PAY_RENT', payload: { amount: data.amount, tile: data.tile } });
                             dispatch({ type: 'NEXT_TURN' });
                         }} className="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold">立即支付</button>
                    </Modal>
                );
            }

            if (type === 'INSPECT') {
                const { tile } = data;
                const owner = players.find(p => p.id === tile.owner);
                const groupColor = PROPERTY_COLORS[tile.group] || '#cbd5e1';
                const houseCost = Math.floor(tile.price * 0.5);
                const nextRent = tile.rent * (tile.level + 2);
                const handleUpgrade = () => { dispatch({ type: 'UPGRADE_TILE', payload: { tile } }); dispatch({ type: 'CLOSE_MODAL' }); };

                return (
                    <Modal onClose={handleClose} headerClass="p-0">
                         <div style={{ backgroundColor: groupColor }} className="h-16 w-full flex items-center justify-center">
                             <h3 className="text-white font-bold text-xl shadow-sm">{tile.name}</h3>
                         </div>
                         <div className="mt-4 space-y-4">
                             <div className="grid grid-cols-3 gap-2 text-center">
                                 <div className="flex flex-col p-2 bg-slate-50 rounded-lg">
                                     <span className="text-xs uppercase text-slate-500 font-bold">基礎租金</span>
                                     <span className="text-lg font-bold text-slate-700">${tile.rent}</span>
                                 </div>
                                 <div className="flex flex-col p-2 bg-slate-50 rounded-lg">
                                     <span className="text-xs uppercase text-slate-500 font-bold">等級</span>
                                     <span className="text-lg font-bold text-slate-700">{tile.level}/4</span>
                                 </div>
                                 <div className="flex flex-col p-2 bg-emerald-50 border border-emerald-100 rounded-lg">
                                     <span className="text-xs uppercase text-emerald-600 font-bold">建築成本</span>
                                     <span className="text-lg font-bold text-emerald-700">${houseCost}</span>
                                 </div>
                             </div>
                             <div className="flex items-center justify-between p-3 border border-slate-100 rounded-xl">
                                 <span className="text-slate-500 font-medium">擁有者</span>
                                 {owner ? (
                                     <div className="flex items-center gap-2">
                                         <span className="font-bold text-slate-700">{owner.name}</span>
                                         <div className={`w-6 h-6 rounded-full ${owner.color}`}></div>
                                     </div>
                                 ) : (
                                     <span className="text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded">出售中 (${tile.price})</span>
                                 )}
                             </div>
                             {owner && tile.level < 4 && (
                                 <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                     <div className="flex justify-between items-center mb-2">
                                         <span className="text-sm font-bold text-slate-600">升級潛力</span>
                                         <span className="text-xs text-brand-green font-bold">下級租金: ${nextRent}</span>
                                     </div>
                                     <button onClick={handleUpgrade} className="w-full py-2 bg-brand-green text-white rounded-lg font-bold text-sm hover:bg-emerald-600 transition-colors flex items-center justify-center gap-2">
                                         <HouseIcon /> 蓋房子 (-${houseCost})
                                     </button>
                                 </div>
                             )}
                         </div>
                    </Modal>
                );
            }
            return null;
        }

        function HelpModal({ isOpen, onClose }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-3xl max-w-lg w-full p-8 shadow-2xl modal-enter relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <h2 className="text-3xl font-extrabold text-emerald-600 mb-4">如何遊玩</h2>
                        <div className="space-y-4 text-slate-600 overflow-y-auto max-h-[60vh] pr-2">
                            <div><h4 className="font-bold text-slate-800">1. 目標</h4><p className="text-sm">成為最後一個破產的玩家，或是擁有最多資產的人！</p></div>
                            <div><h4 className="font-bold text-slate-800">2. 移動</h4><p className="text-sm">擲骰子在版圖上移動。停留在無人地產時可以購買。</p></div>
                            <div><h4 className="font-bold text-slate-800">3. 購買與租金</h4><p className="text-sm">購買前需要回答永續發展問題！如果該地已被購買，則需支付租金。</p></div>
                            <div><h4 className="font-bold text-slate-800">4. 升級與壟斷</h4><p className="text-sm">擁有同色系所有地產可使租金翻倍！蓋房子可進一步提高租金。</p></div>
                            <div><h4 className="font-bold text-slate-800">5. 監獄</h4><p className="text-sm">如果走到「入獄」，你將被暫停行動，直到支付保釋金或擲出雙骰。</p></div>
                        </div>
                        <button onClick={onClose} className="mt-6 w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">明白了！</button>
                    </div>
                </div>
            );
        }

        function App() {
            const [state, dispatch] = useReducer(reducer, initialState);
            const [showHelp, setShowHelp] = useState(true);
            const [visualDice, setVisualDice] = useState([1, 1]);
            const isMovingRef = useRef(false);

            useEffect(() => {
                let interval;
                if (state.isDiceRolling) {
                    interval = setInterval(() => { setVisualDice([Math.ceil(Math.random()*6), Math.ceil(Math.random()*6)]); }, 80);
                } else {
                    setVisualDice(state.dice);
                }
                return () => clearInterval(interval);
            }, [state.isDiceRolling, state.dice]);

            useEffect(() => {
                if (state.screen !== 'GAME') return;
                if (state.stepsRemaining > 0) {
                    isMovingRef.current = true;
                    const timer = setTimeout(() => { dispatch({ type: 'MOVE_STEP' }); }, 300);
                    return () => clearTimeout(timer);
                } else if (state.stepsRemaining === 0 && isMovingRef.current) {
                    isMovingRef.current = false;
                    const timer = setTimeout(() => { dispatch({ type: 'LAND_ON_TILE' }); }, 400); 
                    return () => clearTimeout(timer);
                }
            }, [state.stepsRemaining, state.screen]);

            if (state.screen === 'SETUP') return <SetupScreen onStart={(players) => dispatch({ type: 'START_GAME', payload: players })} />;

            const currentPlayer = state.players[state.currentPlayerIdx] || { money: 0, name: '?', color: 'bg-gray-500', isInJail: false };

            const rollDice = () => {
                if (state.isDiceRolling || state.activeModal || state.stepsRemaining > 0) return;
                dispatch({ type: 'ROLL_DICE_START' });
                setTimeout(() => {
                    const d1 = Math.ceil(Math.random() * 6);
                    const d2 = Math.ceil(Math.random() * 6);
                    dispatch({ type: 'ROLL_DICE_COMPLETE', payload: { die1: d1, die2: d2 } });
                }, 1000);
            };

            const payBail = () => dispatch({ type: 'PAY_BAIL' });

            return (
                <div className="relative min-h-screen flex items-center justify-center p-2 overflow-hidden">
                    <div className="absolute inset-0 opacity-30 pattern-dots pointer-events-none"></div>
                    <button onClick={() => setShowHelp(true)} className="fixed top-4 right-4 z-40 w-10 h-10 bg-white/80 backdrop-blur rounded-full shadow-lg flex items-center justify-center font-bold text-emerald-600 hover:scale-110 transition-transform">?</button>
                    <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />

                    <div className="relative w-[95vmin] h-[95vmin] max-w-[800px] max-h-[800px]">
                        <div className="absolute inset-0 grid grid-cols-6 grid-rows-6 gap-1 p-1 bg-white/40 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50">
                            
                            {/* Center Hub */}
                            <div className="col-start-2 col-end-6 row-start-2 row-end-6 relative flex flex-col items-center justify-center p-4">
                                <div className="absolute inset-0 bg-white/30 rounded-2xl"></div>
                                <div className="z-10 text-center mb-4">
                                    <h1 className="text-4xl font-black text-emerald-600 tracking-tight drop-shadow-sm">EcoPoly</h1>
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">永續發展目標版</span>
                                </div>
                                <div className="z-10 w-full h-24 overflow-y-auto mb-4 text-xs space-y-1 text-center scrollbar-hide opacity-80">
                                    {state.log.slice(-5).reverse().map((l, i) => <div key={i} className="bg-white/60 px-2 py-1 rounded text-slate-600">{l}</div>)}
                                </div>
                                <div className="z-10 flex flex-col items-center gap-4">
                                    <div className={`flex gap-3 transition-transform ${state.isDiceRolling ? 'animate-dice-shake' : ''}`}>
                                        {visualDice.map((d, i) => (
                                            <div key={i} className="w-12 h-12 bg-white rounded-xl shadow-lg border border-slate-200 flex items-center justify-center text-2xl font-bold text-slate-800 relative overflow-hidden">
                                                <div className="absolute inset-0 bg-gradient-to-br from-white to-slate-100"></div>
                                                <span className="relative z-10">{d}</span>
                                            </div>
                                        ))}
                                    </div>
                                    {currentPlayer.isInJail ? (
                                        <div className="flex flex-col gap-2 w-40">
                                            <button onClick={rollDice} disabled={state.isDiceRolling} className="w-full py-2 bg-indigo-500 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-600 active:scale-95 transition-all disabled:opacity-50">嘗試雙骰</button>
                                            <button onClick={payBail} disabled={currentPlayer.money < 50} className="w-full py-2 bg-slate-500 text-white font-bold rounded-lg shadow-lg hover:bg-slate-600 active:scale-95 transition-all disabled:opacity-50">保釋 ($50)</button>
                                        </div>
                                    ) : (
                                        <button onClick={rollDice} disabled={state.isDiceRolling || state.activeModal || state.stepsRemaining > 0} className="group relative px-8 py-3 rounded-2xl font-black text-white shadow-xl bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span className="relative z-10 flex items-center gap-2">{state.isDiceRolling ? '擲骰中...' : state.stepsRemaining > 0 ? '移動中...' : '擲骰子'}</span>
                                        </button>
                                    )}
                                </div>
                            </div>

                            {state.board.map(tile => <Tile key={tile.id} data={tile} players={state.players} onClick={(t) => dispatch({ type: 'OPEN_INSPECT', payload: t })} />)}

                            <div className="absolute inset-0 pointer-events-none">
                                {state.players.map((p, i) => {
                                    if (!p) return null;
                                    const coords = getTileCoordinates(p.position || 0);
                                    return (
                                        <div key={p.id || i} className="absolute w-[6vmin] h-[6vmin] flex items-center justify-center transition-all duration-300 ease-in-out z-50" style={{ top: `calc(${coords.top}% + 1%)`, left: `calc(${coords.left}% + 1%)`, width: '15%', height: '15%' }}>
                                            <div className={`w-[3vmin] h-[3vmin] rounded-full ${p.color} border-2 border-white shadow-md relative transform hover:scale-125 transition-transform`}>
                                                <div className="absolute -top-3 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-800 bg-white/80 px-1 rounded shadow-sm opacity-0 group-hover:opacity-100 whitespace-nowrap">{p.name}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-4 flex justify-center gap-4 pointer-events-none">
                        {state.players.map((p, i) => (
                            <div key={p.id || i} className={`pointer-events-auto glass-panel px-4 py-2 rounded-2xl flex items-center gap-3 transition-all duration-500 ${state.currentPlayerIdx === i ? 'scale-110 ring-4 ring-emerald-400/50 -translate-y-2' : 'scale-90 opacity-80'}`}>
                                <div className={`w-10 h-10 rounded-full ${p.color} border-2 border-white shadow flex items-center justify-center text-white font-bold`}>{p.name.charAt(0)}</div>
                                <div>
                                    <div className="font-bold text-slate-800 text-sm flex items-center gap-1">{p.name}{p.isInJail && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded border border-red-200">入獄</span>}</div>
                                    <div className="text-emerald-600 font-black text-lg">${p.money}</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <ModalManager activeModal={state.activeModal} dispatch={dispatch} players={state.players} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>