
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoPoly: SDG Edition</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. PeerJS for P2P Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- 4. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-white': 'rgba(255, 255, 255, 0.7)',
                        'glass-dark': 'rgba(15, 23, 42, 0.6)',
                        'brand-green': '#10b981',
                        'brand-blue': '#3b82f6',
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background: linear-gradient(135deg, #dcfce7 0%, #dbeafe 100%);
            overflow: hidden; 
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalPop {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .tile-shadow { box-shadow: inset 0 0 20px rgba(0,0,0,0.03); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef } = React;

        // --- 1. CONSTANTS ---
        const TileType = { PROPERTY: 'PROPERTY', START: 'START', CHANCE: 'CHANCE', JAIL: 'JAIL', TAX: 'TAX', PARKING: 'PARKING' };

        const INITIAL_TILES = [
            { id: 0, name: 'GO', type: TileType.START, description: 'Collect $200' },
            { id: 1, name: 'Solar Farm', type: TileType.PROPERTY, price: 60, rent: 10, group: 'brown' },
            { id: 2, name: 'Chance', type: TileType.CHANCE },
            { id: 3, name: 'Wind Turbine', type: TileType.PROPERTY, price: 60, rent: 15, group: 'brown' },
            { id: 4, name: 'Eco Tax', type: TileType.TAX, price: 100, description: 'Pay $100' },
            { id: 5, name: 'Hydro Dam', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue' }, 
            { id: 6, name: 'Recycle Hub', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue' },
            { id: 7, name: 'Bio Lab', type: TileType.PROPERTY, price: 120, rent: 25, group: 'light_blue' },
            { id: 8, name: 'Jail', type: TileType.JAIL, description: 'Visit Only' },
            { id: 9, name: 'Comm. Garden', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink' },
            { id: 10, name: 'Tesla Stn', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink' }, 
            { id: 11, name: 'Green Uni', type: TileType.PROPERTY, price: 160, rent: 35, group: 'pink' },
            { id: 12, name: 'Free Park', type: TileType.PARKING, description: 'Relax' },
            { id: 13, name: 'E-Bus Depot', type: TileType.PROPERTY, price: 180, rent: 40, group: 'orange' },
            { id: 14, name: 'Chance', type: TileType.CHANCE },
            { id: 15, name: 'Metro', type: TileType.PROPERTY, price: 200, rent: 45, group: 'orange' }, 
            { id: 16, name: 'Forest', type: TileType.PROPERTY, price: 220, rent: 50, group: 'red' },
            { id: 17, name: 'Ocean Cleaner', type: TileType.PROPERTY, price: 220, rent: 50, group: 'red' },
            { id: 18, name: 'Pure Water', type: TileType.PROPERTY, price: 240, rent: 60, group: 'red' },
            { id: 19, name: 'Climate Summit', type: TileType.PROPERTY, price: 350, rent: 100, group: 'blue' },
        ];

        const SDG_QUESTIONS = [
            { q: "SDG 1 aims to end what?", a: ["Poverty", "Hunger", "War", "Disease"], correct: 0 },
            { q: "SDG 13 focuses on...", a: ["Water", "Education", "Climate Action", "Economy"], correct: 2 },
            { q: "Which energy is renewable?", a: ["Coal", "Solar", "Oil", "Gas"], correct: 1 },
            { q: "SDG 14 protects...", a: ["Forests", "Space", "Life Below Water", "Cities"], correct: 2 },
            { q: "Reuse, Reduce, ...", a: ["Rebound", "Recycle", "Reject", "Remake"], correct: 1 },
        ];

        const COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b']; // Red, Blue, Green, Yellow

        // --- 2. GAME ENGINE ---
        const initialState = {
            players: [],
            currentPlayerIndex: 0,
            tiles: INITIAL_TILES,
            gameStatus: 'LOBBY', // LOBBY, PLAYING, GAME_OVER
            logs: [],
            dice: [1, 1]
        };

        const reducer = (state, action) => {
            switch (action.type) {
                case 'FULL_SYNC': return action.payload; // Client simply replaces state
                case 'ADD_PLAYER':
                    if (state.players.find(p => p.peerId === action.payload.peerId)) return state;
                    return {
                        ...state,
                        players: [...state.players, { ...action.payload, color: COLORS[state.players.length % 4], money: 1500, position: 0, properties: [] }],
                        logs: [`${action.payload.name} joined!`, ...state.logs]
                    };
                case 'START_GAME':
                    return { ...state, gameStatus: 'PLAYING', logs: ['Game Started! GLHF!', ...state.logs] };
                case 'ROLL_DICE': {
                    const pIndex = state.currentPlayerIndex;
                    const player = state.players[pIndex];
                    const d1 = Math.ceil(Math.random() * 6);
                    const d2 = Math.ceil(Math.random() * 6);
                    const move = d1 + d2;
                    let newPos = (player.position + move) % 20;
                    let money = player.money;
                    let logs = [...state.logs];

                    if (newPos < player.position) {
                        money += 200;
                        logs.unshift(`${player.name} passed GO! +$200`);
                    }

                    // Simple instant effects
                    const tile = state.tiles[newPos];
                    if (tile.type === TileType.TAX) {
                        money -= tile.price;
                        logs.unshift(`${player.name} paid Tax $${tile.price}`);
                    }
                    if (tile.type === TileType.CHANCE) {
                        const luck = Math.random();
                        if (luck > 0.5) { money += 50; logs.unshift("Chance: Eco Subsidy +$50"); }
                        else { money -= 30; logs.unshift("Chance: Carbon Fee -$30"); }
                    }

                    const newPlayers = state.players.map((p, i) => i === pIndex ? { ...p, position: newPos, money } : p);
                    return { ...state, dice: [d1, d2], players: newPlayers, logs: [`${player.name} rolled ${move}`, ...logs] };
                }
                case 'END_TURN':
                    return { ...state, currentPlayerIndex: (state.currentPlayerIndex + 1) % state.players.length };
                case 'BUY_TILE': {
                    const { playerId, tileId } = action.payload;
                    const player = state.players.find(p => p.peerId === playerId);
                    const tile = state.tiles[tileId];
                    if (player.money < tile.price) return state;
                    
                    const updatedPlayers = state.players.map(p => p.peerId === playerId ? { ...p, money: p.money - tile.price, properties: [...p.properties, tileId] } : p);
                    const updatedTiles = state.tiles.map(t => t.id === tileId ? { ...t, ownerId: playerId } : t);
                    return { ...state, players: updatedPlayers, tiles: updatedTiles, logs: [`${player.name} bought ${tile.name}`, ...state.logs] };
                }
                case 'PAY_RENT': {
                    const { fromId, toId, amount } = action.payload;
                    return {
                        ...state,
                        players: state.players.map(p => {
                            if (p.peerId === fromId) return { ...p, money: p.money - amount };
                            if (p.peerId === toId) return { ...p, money: p.money + amount };
                            return p;
                        }),
                        logs: [`Rent paid: $${amount}`, ...state.logs]
                    };
                }
                default: return state;
            }
        };

        // --- 3. COMPONENTS ---

        const IconDice = ({ val }) => (
            <svg viewBox="0 0 100 100" className="w-full h-full bg-white rounded-xl shadow-inner border border-slate-200">
                {val === 1 && <circle cx="50" cy="50" r="12" fill="#333"/>}
                {val === 2 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 3 && <><circle cx="25" cy="25" r="12" fill="#333"/><circle cx="50" cy="50" r="12" fill="#333"/><circle cx="75" cy="75" r="12" fill="#333"/></>}
                {val === 4 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="30" r="12" fill="#333"/><circle cx="30" cy="70" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 5 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="30" r="12" fill="#333"/><circle cx="50" cy="50" r="12" fill="#333"/><circle cx="30" cy="70" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 6 && <><circle cx="30" cy="20" r="10" fill="#333"/><circle cx="70" cy="20" r="10" fill="#333"/><circle cx="30" cy="50" r="10" fill="#333"/><circle cx="70" cy="50" r="10" fill="#333"/><circle cx="30" cy="80" r="10" fill="#333"/><circle cx="70" cy="80" r="10" fill="#333"/></>}
            </svg>
        );

        const Modal = ({ title, children, onClose, color = "bg-brand-blue" }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
                <div className="glass-panel w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl modal-enter">
                    <div className={`${color} p-4 text-white text-center font-bold text-lg tracking-wide`}>{title}</div>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );

        const Instructions = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
                <div className="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl modal-enter">
                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white">
                        <h2 className="text-3xl font-extrabold">Welcome to EcoPoly! üå±</h2>
                        <p className="opacity-90 mt-1">Sustainability meets Strategy.</p>
                    </div>
                    <div className="p-6 space-y-4 text-slate-700 leading-relaxed max-h-[60vh] overflow-y-auto">
                        <p><strong>Goal:</strong> Be the wealthiest player while promoting Sustainable Development Goals (SDGs). Bankrupt players are out.</p>
                        <ul className="list-disc pl-5 space-y-2">
                            <li><strong>Roll & Move:</strong> Navigate the board to find eco-projects.</li>
                            <li><strong>Buy Properties:</strong> Land on unowned tiles? Answer an <em>SDG Quiz</em> to buy them!</li>
                            <li><strong>Pay Rent:</strong> Landing on opponent's tiles costs money.</li>
                            <li><strong>Corners:</strong> Watch out for Eco Tax and Jail!</li>
                        </ul>
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                            <strong>Multiplayer Tip:</strong> One person creates the game (Host), others join using the Game ID. Host must stay online!
                        </div>
                    </div>
                    <div className="p-4 border-t bg-slate-50 flex justify-end">
                        <button onClick={onClose} className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95">
                            Let's Play!
                        </button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [state, dispatch] = useReducer(reducer, initialState);
            const [myId, setMyId] = useState(null);
            const [hostIdInput, setHostIdInput] = useState('');
            const [nameInput, setNameInput] = useState('Player ' + Math.floor(Math.random()*100));
            const [isHost, setIsHost] = useState(false);
            const [peer, setPeer] = useState(null);
            const [conn, setConn] = useState(null); // For Client
            const [conns, setConns] = useState([]); // For Host
            const [msg, setMsg] = useState('');
            const [showHelp, setShowHelp] = useState(true);

            // Modal States
            const [activeModal, setActiveModal] = useState(null); // { type: 'QUIZ'|'RENT', data: ... }

            // 1. Initialize Peer
            useEffect(() => {
                const p = new Peer(undefined, { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
                p.on('open', (id) => { setMyId(id); setMsg('Ready to Connect'); });
                p.on('error', (err) => setMsg('Error: ' + err.type));
                
                // HOST LOGIC: Listen for connections
                p.on('connection', (c) => {
                    c.on('open', () => {
                        setConns(prev => [...prev, c]); // Add to broadcast list
                        // Listen for actions from this client
                        c.on('data', (data) => {
                            if (data.type === 'ACTION') {
                                dispatch(data.payload); // Execute locally
                            } else if (data.type === 'JOIN') {
                                dispatch({ type: 'ADD_PLAYER', payload: data.payload });
                            }
                        });
                    });
                });

                setPeer(p);
                return () => p.destroy();
            }, []);

            // 2. State Broadcast (Host Only)
            useEffect(() => {
                if (isHost && conns.length > 0) {
                    conns.forEach(c => {
                        if (c.open) c.send({ type: 'FULL_SYNC', payload: state });
                    });
                }
            }, [state, isHost, conns]);

            // 3. Helper Functions
            const createGame = () => {
                setIsHost(true);
                dispatch({ type: 'ADD_PLAYER', payload: { peerId: myId, name: nameInput } });
                dispatch({ type: 'START_GAME' });
            };

            const joinGame = () => {
                if (!hostIdInput || !peer) return;
                setMsg('Connecting...');
                const c = peer.connect(hostIdInput);
                c.on('open', () => {
                    setMsg('Connected! Waiting for host...');
                    setConn(c);
                    // Send Join Request
                    c.send({ type: 'JOIN', payload: { peerId: myId, name: nameInput } });
                });
                c.on('data', (data) => {
                    if (data.type === 'FULL_SYNC') {
                        dispatch({ type: 'FULL_SYNC', payload: data.payload });
                    }
                });
            };

            const sendGameAction = (action) => {
                // If Host, do it locally (useEffect will broadcast). If Client, send to Host.
                if (isHost) {
                    dispatch(action);
                } else if (conn && conn.open) {
                    conn.send({ type: 'ACTION', payload: action });
                }
            };

            // 4. Game Logic Triggers (Movement, Land on Tile)
            const myPlayer = state.players.find(p => p.peerId === myId);
            const isMyTurn = state.players[state.currentPlayerIndex]?.peerId === myId;
            const prevPosRef = useRef(0);

            useEffect(() => {
                if (!myPlayer || !isMyTurn) return;
                if (myPlayer.position !== prevPosRef.current) {
                    // Landed logic
                    const tile = state.tiles[myPlayer.position];
                    
                    // Delay slightly for visual movement
                    setTimeout(() => {
                        if (tile.type === TileType.PROPERTY) {
                            if (!tile.ownerId) {
                                // Offer to buy
                                const q = SDG_QUESTIONS[Math.floor(Math.random() * SDG_QUESTIONS.length)];
                                setActiveModal({ type: 'QUIZ', tile, q });
                            } else if (tile.ownerId !== myId) {
                                // Pay Rent
                                setActiveModal({ type: 'RENT', tile, amount: tile.rent });
                            }
                        }
                    }, 600);
                    
                    prevPosRef.current = myPlayer.position;
                }
            }, [myPlayer?.position, isMyTurn]);

            // 5. Grid Layout Logic
            const getGridStyle = (i) => {
                // 6x6 Grid. 0=BottomRight, 5=BottomLeft, 10=TopLeft, 15=TopRight
                let col, row;
                if (i <= 5) { row = 6; col = 6 - i; } // Bottom: 6,5,4,3,2,1
                else if (i <= 10) { row = 6 - (i - 5); col = 1; } // Left: 5,4,3,2,1
                else if (i <= 15) { row = 1; col = 1 + (i - 10); } // Top: 1,2,3,4,5,6
                else { row = 1 + (i - 15); col = 6; } // Right: 2,3,4,5

                return { gridColumn: col, gridRow: row };
            };

            // --- RENDER ---

            // A. Help Button
            const HelpBtn = () => (
                <button onClick={() => setShowHelp(true)} className="fixed top-4 right-4 z-40 bg-white/80 backdrop-blur shadow-lg rounded-full w-10 h-10 flex items-center justify-center font-bold text-slate-700 hover:scale-110 transition border border-slate-200">
                    ?
                </button>
            );

            // B. Lobby View
            if (state.gameStatus === 'LOBBY') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        {showHelp && <Instructions onClose={() => setShowHelp(false)} />}
                        {!showHelp && <HelpBtn />}
                        
                        <div className="glass-panel max-w-md w-full p-8 rounded-3xl text-center space-y-6 animate-pop">
                            <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500 drop-shadow-sm">EcoPoly</h1>
                            
                            <div className="space-y-2 text-left">
                                <label className="text-sm font-bold text-slate-600 ml-1">Your Name</label>
                                <input className="w-full p-4 bg-white/50 border border-white rounded-xl focus:ring-2 ring-emerald-400 outline-none transition font-bold text-slate-700" value={nameInput} onChange={e => setNameInput(e.target.value)} />
                            </div>

                            {!myId ? (
                                <div className="text-slate-400 font-bold animate-pulse">Initializing Network...</div>
                            ) : (
                                <div className="space-y-4">
                                    <button onClick={createGame} className="w-full bg-gradient-to-r from-emerald-400 to-teal-500 text-white p-4 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:shadow-xl transform hover:-translate-y-1 transition">
                                        Create Game (Host)
                                    </button>
                                    
                                    <div className="relative flex py-2 items-center">
                                        <div className="flex-grow border-t border-slate-300"></div>
                                        <span className="flex-shrink mx-4 text-slate-400 text-sm font-bold">OR JOIN</span>
                                        <div className="flex-grow border-t border-slate-300"></div>
                                    </div>

                                    <div className="flex gap-2">
                                        <input className="flex-1 p-3 bg-white/50 border border-white rounded-xl outline-none text-center font-mono text-sm" placeholder="Paste Host ID" value={hostIdInput} onChange={e => setHostIdInput(e.target.value)} />
                                        <button onClick={joinGame} className="bg-blue-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-600 transition">Join</button>
                                    </div>
                                    <div className="text-xs text-slate-500 font-bold min-h-[20px]">{msg}</div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // C. Game View
            return (
                <div className="h-screen w-full flex flex-col md:flex-row items-center justify-center bg-slate-100 overflow-hidden relative">
                    {showHelp && <Instructions onClose={() => setShowHelp(false)} />}
                    <HelpBtn />

                    {/* Left: Player List */}
                    <div className="md:absolute md:left-6 md:top-6 md:bottom-6 w-full md:w-72 glass-panel md:rounded-3xl flex flex-col z-20 md:z-10 order-2 md:order-1 h-[20vh] md:h-auto border-t md:border-t-0">
                        <div className="p-4 border-b border-slate-200/50 flex justify-between items-center">
                            <span className="font-bold text-slate-700">Players</span>
                            <button className="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200" onClick={() => navigator.clipboard.writeText(myId)}>COPY ID</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {state.players.map((p, i) => (
                                <div key={i} className={`p-3 rounded-xl flex justify-between items-center transition-all ${state.currentPlayerIndex === i ? 'bg-white shadow-md border-l-4 border-emerald-500' : 'hover:bg-white/40'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full shadow-inner flex items-center justify-center text-white font-bold text-xs" style={{backgroundColor: p.color}}>{p.name[0]}</div>
                                        <div className="flex flex-col">
                                            <span className="text-sm font-bold text-slate-800">{p.name}</span>
                                            <span className="text-xs text-slate-500">Pos: {state.tiles[p.position].name}</span>
                                        </div>
                                    </div>
                                    <span className="font-mono font-bold text-emerald-700">${p.money}</span>
                                </div>
                            ))}
                        </div>
                        <div className="h-32 bg-slate-900/5 p-3 overflow-y-auto text-xs font-mono space-y-1 border-t border-slate-200/50 text-slate-600">
                            {state.logs.map((l, i) => <div key={i}>&gt; {l}</div>)}
                        </div>
                    </div>

                    {/* Center: Board */}
                    <div className="flex-1 w-full h-full flex items-center justify-center order-1 md:order-2 p-2 md:p-0">
                        <div className="relative bg-white rounded-xl shadow-2xl border-[8px] border-slate-800 box-border overflow-hidden" 
                             style={{ width: '95vmin', height: '95vmin', maxWidth: '800px', maxHeight: '800px' }}>
                            
                            <div className="w-full h-full grid grid-cols-6 grid-rows-6">
                                
                                {/* Tiles */}
                                {state.tiles.map((tile, i) => {
                                    const style = getGridStyle(i);
                                    const owner = state.players.find(p => p.peerId === tile.ownerId);
                                    const isCorner = tile.type !== TileType.PROPERTY;
                                    
                                    // Visuals
                                    const groupColor = 
                                        tile.group === 'brown' ? 'bg-amber-700' : 
                                        tile.group === 'light_blue' ? 'bg-sky-400' :
                                        tile.group === 'pink' ? 'bg-pink-400' :
                                        tile.group === 'orange' ? 'bg-orange-400' :
                                        tile.group === 'red' ? 'bg-red-500' :
                                        tile.group === 'blue' ? 'bg-blue-600' : 'bg-slate-300';

                                    return (
                                        <div key={i} style={style} className={`relative border border-slate-200 flex flex-col overflow-hidden tile-shadow ${isCorner ? 'bg-slate-50' : 'bg-white'}`}>
                                            {!isCorner && <div className={`h-1/5 w-full ${groupColor}`}></div>}
                                            <div className="flex-1 flex flex-col items-center justify-center p-1 text-center">
                                                <span className="text-[1.8vmin] font-bold leading-tight text-slate-800">{tile.name}</span>
                                                {!isCorner && !owner && <span className="text-[1.5vmin] text-slate-400 mt-1">${tile.price}</span>}
                                                {isCorner && <span className="text-[3vmin]">{tile.id===0?'üèÅ':tile.id===4?'üí∏':tile.id===8?'‚õìÔ∏è':tile.id===12?'üÖøÔ∏è':'‚ùì'}</span>}
                                            </div>
                                            {/* Players on Tile */}
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none gap-1">
                                                {state.players.filter(p => p.position === i).map(p => (
                                                    <div key={p.peerId} className="w-[2.5vmin] h-[2.5vmin] rounded-full border border-white shadow-lg z-10" style={{backgroundColor: p.color}}></div>
                                                ))}
                                            </div>
                                            {/* Owner Marker */}
                                            {owner && <div className="absolute inset-0 border-4 opacity-30 pointer-events-none" style={{borderColor: owner.color}}></div>}
                                        </div>
                                    );
                                })}

                                {/* Center Hub */}
                                <div className="col-start-2 col-end-6 row-start-2 row-end-6 bg-slate-50 flex flex-col items-center justify-center relative pattern-bg">
                                    <div className="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-green-300 via-blue-100 to-transparent"></div>
                                    <h1 className="text-[8vmin] font-black text-slate-900/10 -rotate-12 select-none absolute">EcoPoly</h1>
                                    
                                    {/* Dice & Controls */}
                                    <div className="z-10 flex flex-col items-center gap-4">
                                        <div className="flex gap-4 h-16 md:h-20">
                                            <div className="h-full aspect-square"><IconDice val={state.dice[0]} /></div>
                                            <div className="h-full aspect-square"><IconDice val={state.dice[1]} /></div>
                                        </div>
                                        
                                        {isMyTurn ? (
                                            <div className="flex gap-2">
                                                <button onClick={() => sendGameAction({ type: 'ROLL_DICE' })} className="bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-600 hover:scale-105 transition">ROLL DICE</button>
                                                <button onClick={() => sendGameAction({ type: 'END_TURN' })} className="bg-slate-200 text-slate-600 px-4 py-3 rounded-xl font-bold hover:bg-slate-300 transition">SKIP</button>
                                            </div>
                                        ) : (
                                            <div className="bg-white/80 backdrop-blur px-6 py-2 rounded-full font-bold text-slate-500 shadow-sm border border-slate-100">
                                                Waiting for {state.players[state.currentPlayerIndex]?.name}...
                                            </div>
                                        )}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    {activeModal && activeModal.type === 'QUIZ' && (
                        <Modal title="SDG Quiz Challenge!" color="bg-blue-500">
                            <p className="font-bold text-lg text-slate-800 mb-4">{activeModal.q.q}</p>
                            <div className="grid grid-cols-1 gap-2">
                                {activeModal.q.a.map((opt, i) => (
                                    <button key={i} className="text-left p-3 rounded-lg border border-slate-200 hover:bg-blue-50 hover:border-blue-300 font-medium transition text-slate-700"
                                        onClick={() => {
                                            if (i === activeModal.q.correct) {
                                                // Correct
                                                setActiveModal(null);
                                                sendGameAction({ type: 'BUY_TILE', payload: { playerId: myId, tileId: activeModal.tile.id } });
                                            } else {
                                                // Wrong
                                                setActiveModal(null);
                                                sendGameAction({ type: 'END_TURN' }); // Penalize by ending turn (or just doing nothing)
                                                alert("Wrong answer! Property purchase failed.");
                                            }
                                        }}>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </Modal>
                    )}

                    {activeModal && activeModal.type === 'RENT' && (
                        <Modal title="Pay Rent" color="bg-rose-500">
                            <div className="text-center space-y-4">
                                <p className="text-slate-600">You landed on <span className="font-bold text-slate-800">{activeModal.tile.name}</span>.</p>
                                <p className="text-2xl font-black text-rose-600">PAY ${activeModal.amount}</p>
                                <button onClick={() => {
                                    sendGameAction({ type: 'PAY_RENT', payload: { fromId: myId, toId: activeModal.tile.ownerId, amount: activeModal.amount } });
                                    setActiveModal(null);
                                }} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-rose-600 transition">
                                    Pay Now
                                </button>
                            </div>
                        </Modal>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
